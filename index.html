<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="theme-color" content="#ffffff" />
  <title>Daily Fitness Tracker</title>
  <link rel="manifest" href="manifest.json" /> <!-- Create manifest.json for PWA; see notes -->
  <style>
    /* CSS – Daily Fitness Tracker App */
    :root {
      --primary-color: #007bff; /* Button bg */
      --primary-hover: #0056b3;
      --progress-bg: #e0e0e0;
      --progress-fill: linear-gradient(to right, #28a745, #198754); /* Green gradient for success */
      --progress-warning: linear-gradient(to right, #ffc107, #fd7e14); /* Yellow/orange for warning */
      --progress-danger: linear-gradient(to right, #dc3545, #c82333); /* Red for danger */
      --bg-color: #f9f9f9;
      --text-color: #333;
      --border-color: #bbb;
      --summary-bg: #f1f1f1;
      --modal-bg: rgba(0, 0, 0, 0.5);
      --font-stack: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg-color: #1e1e1e;
        --text-color: #ddd;
        --border-color: #555;
        --summary-bg: #2a2a2a;
        --progress-bg: #444;
        --modal-bg: rgba(0, 0, 0, 0.7);
        --progress-fill: linear-gradient(to right, #28a745, #198754);
        --progress-warning: linear-gradient(to right, #ffc107, #fd7e14);
        --progress-danger: linear-gradient(to right, #dc3545, #c82333);
      }
      body {
        background-color: var(--bg-color);
        color: var(--text-color);
      }
    }

    body {
      margin: 0;
      font-family: var(--font-stack);
      background-color: var(--bg-color);
      color: var(--text-color);
      line-height: 1.5;
    }

    .app-container {
      padding: 20px;
      max-width: 600px;
      margin: auto;
    }

    header h1 {
      text-align: center;
      font-size: clamp(1.5em, 5vw, 1.8em);
      margin-bottom: 20px;
    }

    section {
      margin-bottom: 30px;
    }

    h2 {
      margin-top: 0;
      font-size: 1.3em;
      border-bottom: 2px solid var(--border-color);
      padding-bottom: 5px;
    }

    label {
      display: block;
      margin: 10px 0 5px;
      font-weight: 500;
    }

    input[type="number"],
    input[type="text"] {
      width: 100%;
      padding: 8px;
      font-size: 1em;
      box-sizing: border-box;
      margin-bottom: 10px;
      border: 1px solid var(--border-color);
      border-radius: 5px;
      background-color: var(--bg-color);
      color: var(--text-color);
    }

    input:focus,
    button:focus {
      outline: 2px solid var(--primary-color);
      outline-offset: 2px;
    }

    button {
      padding: 10px 20px;
      font-size: 1em;
      background-color: var(--primary-color);
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 10px;
      transition: background-color 0.2s ease;
    }

    button:hover {
      background-color: var(--primary-hover);
    }

    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    .progress-bar {
      background-color: var(--progress-bg);
      height: 20px;
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 5px;
      position: relative;
    }

    .progress-bar > div {
      height: 100%;
      background: var(--progress-fill);
      transition: width 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 0.8em;
      position: relative;
    }

    .progress-bar > div.bg-success {
      background: var(--progress-fill); /* Explicit for success */
    }

    .progress-bar > div.bg-warning {
      background: var(--progress-warning);
    }

    .progress-bar > div.bg-danger {
      background: var(--progress-danger);
    }

    .bar-total-label {
      position: absolute;
      right: 10px;
      top: 0;
      height: 100%;
      display: flex;
      align-items: center;
      font-size: 0.9em;
      color: var(--text-color);
      z-index: 1;
    }

    #calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      margin-top: 10px;
    }

    .calendar-header {
      font-weight: bold;
      text-align: center;
      padding: 5px;
      background: var(--summary-bg);
      border-radius: 5px;
    }

    .calendar-day {
      border: 1px solid var(--border-color);
      padding: 5px;
      background: #fff;
      text-align: center;
      border-radius: 5px;
      font-size: 0.85em;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: background-color 0.2s ease;
    }

    .calendar-day:hover {
      background-color: #f0f0f0;
    }

    .calendar-day.current {
      border-color: var(--primary-color);
      box-shadow: 0 0 5px var(--primary-color);
    }

    .calendar-day.other-month {
      color: #aaa;
      background: #f5f5f5;
      cursor: default;
    }

    .date-label {
      font-weight: bold;
      margin-bottom: 5px;
    }

    .emoji-indicators {
      display: flex;
      justify-content: center;
      gap: 2px;
    }

    .summary-section {
      font-size: 0.95em;
      background: var(--summary-bg);
      padding: 10px;
      border-radius: 8px;
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: var(--modal-bg);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .modal:not(.hidden) {
      opacity: 1;
    }

    .modal-content {
      background: var(--bg-color);
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
      position: relative;
    }

    .hidden {
      display: none;
    }

    .close-button {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 1.5em;
      cursor: pointer;
      color: var(--text-color);
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @media (max-width: 480px) {
      .app-container {
        padding: 10px;
      }
      button {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <header>
      <h1>Daily Fitness Tracker</h1>
    </header>

    <section class="goals-section">
      <h2>Set Your Daily Goals</h2>
      <form class="goal-inputs">
        <label>Push-ups: <input type="number" id="goalPushups" value="200" min="0" aria-label="Daily push-ups goal" /></label>
        <label>Pull-ups: <input type="number" id="goalPullups" value="20" min="0" aria-label="Daily pull-ups goal" /></label>
        <label>Air Squats: <input type="number" id="goalSquats" value="200" min="0" aria-label="Daily air squats goal" /></label>
      </form>
    </section>

    <section class="entry-section">
      <h2>Today's Activity</h2>
      <form class="entry-inputs">
        <label>Push-ups: <input type="number" id="pushups" min="0" aria-label="Push-ups completed today" /></label>
        <div class="progress-bar" id="progressPushups" role="progressbar" aria-valuemin="0" aria-valuemax="100"><div></div></div>

        <label>Pull-ups: <input type="number" id="pullups" min="0" aria-label="Pull-ups completed today" /></label>
        <div class="progress-bar" id="progressPullups" role="progressbar" aria-valuemin="0" aria-valuemax="100"><div></div></div>

        <label>Air Squats: <input type="number" id="squats" min="0" aria-label="Air squats completed today" /></label>
        <div class="progress-bar" id="progressSquats" role="progressbar" aria-valuemin="0" aria-valuemax="100"><div></div></div>

        <label>Dead Hang (mm:ss): <input type="text" id="deadHang" placeholder="1:30" pattern="\d+:\d{2}" title="Enter time in mm:ss format (e.g., 1:30)" aria-label="Dead hang time in mm:ss" /></label>
        <button type="submit" id="saveEntry">Save Entry</button>
      </form>
    </section>

    <section class="calendar-section">
      <h2>Calendar View - <span id="calendarMonthYear"></span></h2>
      <div id="calendar"></div>
    </section>

    <section class="summary-section">
      <h2>Progress Summary</h2>
      <div id="summary"></div>
    </section>
  </div>

  <div id="editModal" class="modal hidden" role="dialog" aria-modal="true">
    <div class="modal-content">
      <span class="close-button" id="closeModal" aria-label="Close modal">×</span>
      <h3>Edit Entry for <span id="editDateLabel"></span></h3>
      <form>
        <label>Push-ups: <input type="number" id="editPushups" min="0" aria-label="Edit push-ups" /></label>
        <label>Pull-ups: <input type="number" id="editPullups" min="0" aria-label="Edit pull-ups" /></label>
        <label>Air Squats: <input type="number" id="editSquats" min="0" aria-label="Edit air squats" /></label>
        <label>Dead Hang (mm:ss): <input type="text" id="editDeadHang" pattern="\d+:\d{2}" title="Enter time in mm:ss format (e.g., 1:30)" aria-label="Edit dead hang time" /></label>
        <button type="submit" id="saveEdit">Save Changes</button>
      </form>
    </div>
  </div>

  <script>
    // script.js – Daily Fitness Tracker App (with fixes)
    const defaultGoals = {
      pushups: 200,
      pullups: 20,
      squats: 200
    };

    let goals = { ...defaultGoals };
    let activityData = JSON.parse(localStorage.getItem('activityData')) || {};

    function getTodayStr() {
      const today = new Date();
      return today.getFullYear() + '-' +
             String(today.getMonth() + 1).padStart(2, '0') + '-' +
             String(today.getDate()).padStart(2, '0');
    }

    const todayStr = getTodayStr();

    function saveGoals() {
      goals.pushups = parseInt(document.getElementById('goalPushups').value) || 0;
      goals.pullups = parseInt(document.getElementById('goalPullups').value) || 0;
      goals.squats = parseInt(document.getElementById('goalSquats').value) || 0;
      localStorage.setItem('goals', JSON.stringify(goals));
      updateProgressBars();
      renderCalendar(currentYear, currentMonth);
      updateSummary();
    }

    function validateDeadHang(value) {
      return /^\d+:\d{2}$/.test(value);
    }

    function timeToSeconds(timeStr) {
      if (!timeStr) return 0;
      const [mins, secs] = timeStr.split(':').map(Number);
      return mins * 60 + secs;
    }

    function secondsToTime(secs) {
      const mins = Math.floor(secs / 60);
      const remainingSecs = secs % 60;
      return `${mins}:${String(remainingSecs).padStart(2, '0')}`;
    }

    function saveTodayEntry(e) {
      e.preventDefault();
      const deadHang = document.getElementById('deadHang').value.trim();
      if (deadHang && !validateDeadHang(deadHang)) {
        alert('Dead Hang must be in mm:ss format (e.g., 1:30)');
        return;
      }

      const newEntry = {
        pushups: parseInt(document.getElementById('pushups').value) || 0,
        pullups: parseInt(document.getElementById('pullups').value) || 0,
        squats: parseInt(document.getElementById('squats').value) || 0,
        deadHang
      };

      const existing = activityData[todayStr] || { pushups: 0, pullups: 0, squats: 0, deadHang: "" };
      const newDeadHangSecs = timeToSeconds(newEntry.deadHang);
      const existingDeadHangSecs = timeToSeconds(existing.deadHang);
      const maxDeadHang = newDeadHangSecs > existingDeadHangSecs ? newEntry.deadHang : existing.deadHang;

      const updatedEntry = {
        pushups: existing.pushups + newEntry.pushups,
        pullups: existing.pullups + newEntry.pullups,
        squats: existing.squats + newEntry.squats,
        deadHang: maxDeadHang
      };

      activityData[todayStr] = updatedEntry;
      localStorage.setItem('activityData', JSON.stringify(activityData));
      updateProgressBars();
      renderCalendar(currentYear, currentMonth);
      updateSummary();
      sendToGoogleSheets(todayStr, updatedEntry);

      document.getElementById('pushups').value = '';
      document.getElementById('pullups').value = '';
      document.getElementById('squats').value = '';
      document.getElementById('deadHang').value = '';
      if ('vibrate' in navigator) navigator.vibrate(200);
    }

    function sendToGoogleSheets(date, entry) {
      fetch("https://script.google.com/macros/s/AKfycby6_cBMbcJ4fsBvAfwOJe0gfzhNZWCE7onx5iuAMoUnFFlD2WHRVoMKDWciO4LpAva7/exec", {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          date: date,
          pushups: entry.pushups,
          pullups: entry.pullups,
          squats: entry.squats,
          deadHang: entry.deadHang
        })
      })
      .then(res => res.text())
      .then(msg => console.log("✅ Google Sheets Backup:", msg))
      .catch(err => {
        console.error("❌ Google Sheets Backup Failed:", err);
        alert('Failed to backup to Google Sheets. Check console for details.');
      });
    }

    function updateProgressBars() {
      const data = activityData[todayStr] || { pushups: 0, pullups: 0, squats: 0 };

      updateBarWithTotal('progressPushups', data.pushups, goals.pushups);
      updateBarWithTotal('progressPullups', data.pullups, goals.pullups);
      updateBarWithTotal('progressSquats', data.squats, goals.squats);
    }

    function updateBarWithTotal(id, value, goal) {
      let percent = 0;
      if (goal > 0) {
        percent = Math.min((value / goal) * 100, 100);
      } else if (value > 0) {
        percent = 100; // If goal=0 but value>0, treat as complete
      }
      const barContainer = document.getElementById(id);
      const bar = barContainer.firstElementChild;
      bar.style.width = `${percent}%`;
      bar.textContent = `${Math.round(percent)}%`;
      bar.classList.remove('bg-success', 'bg-warning', 'bg-danger');
      if (percent >= 100) bar.classList.add('bg-success');
      else if (percent >= 50) bar.classList.add('bg-warning');
      else bar.classList.add('bg-danger');

      let label = barContainer.querySelector('.bar-total-label');
      if (!label) {
        label = document.createElement('span');
        label.className = 'bar-total-label';
        barContainer.appendChild(label);
      }
      label.textContent = `${value}/${goal}`;
      barContainer.setAttribute('aria-valuenow', percent);
    }

    const entryForm = document.querySelector('.entry-inputs');
    entryForm.addEventListener('submit', saveTodayEntry);

    document.querySelectorAll('.goal-inputs input').forEach(input => {
      input.addEventListener('input', saveGoals);
    });

    const editForm = document.querySelector('#editModal form');
    editForm.addEventListener('submit', saveEditEntry);

    document.getElementById('closeModal').addEventListener('click', () => {
      document.getElementById('editModal').classList.add('hidden');
    });

    function saveEditEntry(e) {
      e.preventDefault();
      const dateStr = document.getElementById('editModal').dataset.date;
      const deadHang = document.getElementById('editDeadHang').value.trim();
      if (deadHang && !validateDeadHang(deadHang)) {
        alert('Dead Hang must be in mm:ss format (e.g., 1:30)');
        return;
      }
      const entry = {
        pushups: parseInt(document.getElementById('editPushups').value) || 0,
        pullups: parseInt(document.getElementById('editPullups').value) || 0,
        squats: parseInt(document.getElementById('editSquats').value) || 0,
        deadHang
      };
      activityData[dateStr] = entry;
      localStorage.setItem('activityData', JSON.stringify(activityData));
      renderCalendar(currentYear, currentMonth);
      updateSummary();
      if (dateStr === todayStr) updateProgressBars();
      sendToGoogleSheets(dateStr, entry);
      document.getElementById('editModal').classList.add('hidden');
    }

    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();

    function renderCalendar(year, month) {
      const calendar = document.getElementById('calendar');
      calendar.innerHTML = '';

      const weekdays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      weekdays.forEach(day => {
        const header = document.createElement('div');
        header.className = 'calendar-header';
        header.textContent = day;
        calendar.appendChild(header);
      });

      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      let date = new Date(firstDay);
      date.setDate(date.getDate() - firstDay.getDay());

      const monthNames = ["January", "February", "March", "April", "May", "June",
                          "July", "August", "September", "October", "November", "December"];
      document.getElementById('calendarMonthYear').textContent = `${monthNames[month]} ${year}`;

      let nav = document.querySelector('.calendar-section nav');
      if (!nav) {
        nav = document.createElement('nav');
        nav.innerHTML = `<button id="prevMonth"><</button> <button id="nextMonth">></button>`;
        document.querySelector('.calendar-section h2').after(nav);
        document.getElementById('prevMonth').addEventListener('click', () => {
          if (month === 0) { month = 11; year--; } else month--;
          renderCalendar(year, month);
        });
        document.getElementById('nextMonth').addEventListener('click', () => {
          if (month === 11) { month = 0; year++; } else month++;
          renderCalendar(year, month);
        });
      }

      while (date < new Date(year, month + 1, 1) || date.getDay() !== 0) {
        const dayBox = document.createElement('div');
        dayBox.className = 'calendar-day';
        const dateStr = date.toISOString().split('T')[0];
        const isCurrentMonth = date.getMonth() === month;

        if (!isCurrentMonth) {
          dayBox.classList.add('other-month');
        }

        if (dateStr === todayStr) dayBox.classList.add('current');

        dayBox.innerHTML = `<div class="date-label">${date.getDate()}</div>`;

        if (activityData[dateStr]) {
          const d = activityData[dateStr];
          const indicators = [
            d.pushups >= goals.pushups ? '✅' : (d.pushups > 0 ? '⚠️' : '❌'),
            d.pullups >= goals.pullups ? '✅' : (d.pullups > 0 ? '⚠️' : '❌'),
            d.squats >= goals.squats ? '✅' : (d.squats > 0 ? '⚠️' : '❌')  // Fixed typo here ('soci' -> ' '✅' )
          ].map(e => `<span title="Pushups/Pullups/Squats">${e}</span>`).join('');
          dayBox.innerHTML += `<div class="emoji-indicators">${indicators}</div>`;
          if (d.deadHang) dayBox.innerHTML += `<div title="Dead Hang">⏱ ${d.deadHang}</div>`;
        }

        if (isCurrentMonth) {
          dayBox.addEventListener('click', () => openEditModal(dateStr));
        }
        calendar.appendChild(dayBox);
        date.setDate(date.getDate() + 1);
      }
      calendar.style.animation = 'fadeIn 0.5s ease';
    }

    function openEditModal(dateStr) {
      const d = activityData[dateStr] || { pushups: 0, pullups: 0, squats: 0, deadHang: "" };
      document.getElementById('editDateLabel').textContent = dateStr;
      document.getElementById('editPushups').value = d.pushups;
      document.getElementById('editPullups').value = d.pullups;
      document.getElementById('editSquats').value = d.squats;
      document.getElementById('editDeadHang').value = d.deadHang;
      document.getElementById('editModal').dataset.date = dateStr;
      document.getElementById('editModal').classList.remove('hidden');
      document.getElementById('editPushups').focus();
    }

    function updateSummary() {
      const now = new Date();
      const startOfWeek = new Date(now);
      startOfWeek.setDate(now.getDate() - now.getDay());
      const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
      const startOfYear = new Date(now.getFullYear(), 0, 1);

      const totals = {
        week: { pushups: 0, pullups: 0, squats: 0, deadHangMax: 0 },
        month: { pushups: 0, pullups: 0, squats: 0, deadHangMax: 0 },
        year: { pushups: 0, pullups: 0, squats: 0, deadHangMax: 0 },
        allTime: { pushups: 0, pullups: 0, squats: 0, deadHangMax: 0 }
      };

      // Sum totals from existing entries
      for (const [dateStr, entry] of Object.entries(activityData)) {
        const date = new Date(dateStr);
        const deadHangSecs = timeToSeconds(entry.deadHang);

        if (date >= startOfWeek) addToTotals(totals.week, entry, deadHangSecs);
        if (date >= startOfMonth) addToTotals(totals.month, entry, deadHangSecs);
        if (date >= startOfYear) addToTotals(totals.year, entry, deadHangSecs);
        addToTotals(totals.allTime, entry, deadHangSecs);
      }

      // Fixed streak: loop day-by-day backward, break on missing or not met
      let streak = 0;
      let checkDate = new Date(now);
      checkDate.setHours(0,0,0,0);
      while (true) {
        const dateStr = checkDate.toISOString().split('T')[0];
        const entry = activityData[dateStr];
        if (entry && entry.pushups >= goals.pushups && entry.pullups >= goals.pullups && entry.squats >= goals.squats) {
          streak++;
        } else {
          break;
        }
        checkDate.setDate(checkDate.getDate() - 1);
        if (streak > 1000) break; // Safety to prevent infinite loop (unlikely)
      }

      const formatMaxHang = secs => secs > 0 ? secondsToTime(secs) : 'N/A';

      const summaryDiv = document.getElementById('summary');
      summaryDiv.innerHTML = `
        <table aria-label="Progress Summary">
          <tr><th>Period</th><th>Pushups (reps)</th><th>Pullups (reps)</th><th>Squats (reps)</th><th>Max Hang</th></tr>
          <tr><td>Week to Date</td><td>${totals.week.pushups}</td><td>${totals.week.pullups}</td><td>${totals.week.squats}</td><td>${formatMaxHang(totals.week.deadHangMax)}</td></tr>
          <tr><td>Month to Date</td><td>${totals.month.pushups}</td><td>${totals.month.pullups}</td><td>${totals.month.squats}</td><td>${formatMaxHang(totals.month.deadHangMax)}</td></tr>
          <tr><td>Year to Date</td><td>${totals.year.pushups}</td><td>${totals.year.pullups}</td><td>${totals.year.squats}</td><td>${formatMaxHang(totals.year.deadHangMax)}</td></tr>
          <tr><td>All Time</td><td>${totals.allTime.pushups}</td><td>${totals.allTime.pullups}</td><td>${totals.allTime.squats}</td><td>${formatMaxHang(totals.allTime.deadHangMax)}</td></tr>
        </table>
        <p><strong>Current Streak:</strong> ${streak} days</p>
      `;
      summaryDiv.setAttribute('aria-live', 'polite');

      if (!document.getElementById('exportData')) {
        const exportBtn = document.createElement('button');
        exportBtn.id = 'exportData';
        exportBtn.textContent = 'Export Data to CSV';
        exportBtn.addEventListener('click', exportCSV);
        summaryDiv.appendChild(exportBtn);
      }
    }

    function addToTotals(t, d, deadSec) {
      t.pushups += d.pushups || 0;
      t.pullups += d.pullups || 0;
      t.squats += d.squats || 0;
      t.deadHangMax = Math.max(t.deadHangMax, deadSec);
    }

    function exportCSV() {
      let csv = 'Date,Pushups,Pullups,Squats,DeadHang\n';
      const sortedEntries = Object.entries(activityData).sort((a, b) => new Date(a[0]) - new Date(b[0]));
      for (const [date, entry] of sortedEntries) {
        csv += `${date},${entry.pushups},${entry.pullups},${entry.squats},${entry.deadHang || ''}\n`;
      }
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'fitness-data.csv';
      a.click();
      URL.revokeObjectURL(url);
    }

    window.addEventListener('DOMContentLoaded', () => {
      const savedGoals = JSON.parse(localStorage.getItem('goals'));
      if (savedGoals) {
        goals = savedGoals;
        document.getElementById('goalPushups').value = goals.pushups;
        document.getElementById('goalPullups').value = goals.pullups;
        document.getElementById('goalSquats').value = goals.squats;
      }
      updateProgressBars();
      renderCalendar(currentYear, currentMonth);
      updateSummary();

      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js').then(reg => console.log('SW registered:', reg)).catch(err => console.error('SW registration failed:', err));
      }
    });
  </script>
</body>
</html>
